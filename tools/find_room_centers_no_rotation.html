<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Center Finder (NO ROTATION) - Building M Floor 1</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .version-badge {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            vertical-align: middle;
        }

        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }

        .instructions h3 {
            margin-top: 0;
            color: #856404;
        }

        .important-note {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            color: #721c24;
        }

        .important-note strong {
            color: #721c24;
        }

        .svg-container {
            border: 2px solid #ddd;
            border-radius: 5px;
            overflow: auto;
            max-height: 600px;
            position: relative;
            background: white;
            cursor: crosshair;
        }

        #svgDisplay {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .coordinates-display {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .coord-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 3px;
            border-left: 4px solid #ff9800;
        }

        .coord-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .coord-value {
            font-family: 'Courier New', monospace;
            color: #2196f3;
            font-size: 14px;
        }

        .rotation-info {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-size: 12px;
            color: #2e7d32;
        }

        .json-output {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
            margin-top: 10px;
        }

        button {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        button:hover {
            background: #f57c00;
        }

        .copy-btn {
            background: #4caf50;
        }

        .copy-btn:hover {
            background: #45a049;
        }

        .room-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .room-btn {
            padding: 8px;
            background: #fff;
            border: 2px solid #ff9800;
            color: #ff9800;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .room-btn:hover {
            background: #ff9800;
            color: white;
        }

        .room-btn.selected {
            background: #4caf50;
            border-color: #4caf50;
            color: white;
        }

        .click-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background: red;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .status.success {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .status.error {
            background: #ffcdd2;
            color: #c62828;
        }

        .warning-box {
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            color: #e65100;
        }

        .next-steps {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 15px 0;
            border-radius: 3px;
        }

        .next-steps h4 {
            margin-top: 0;
            color: #1565c0;
        }

        .next-steps ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .next-steps li {
            margin: 5px 0;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è Room Center Finder - Building M Floor 1 <span class="version-badge">NO ROTATION</span></h1>

        <div class="instructions">
            <h3>üìã Instructions:</h3>
            <ol>
                <li><strong>Click on a room button</strong> below to select which room you want to find the center for</li>
                <li><strong>Click on the SVG map</strong> at the exact center point of that room</li>
                <li>The <strong>SVG coordinates (NO rotation applied)</strong> will be displayed below</li>
                <li><strong>Copy the JSON</strong> and use it with the Coordinate Compensator tool</li>
                <li>The Compensator will transform coordinates to match the rotated map system</li>
            </ol>
            <p><strong>üí° Tip:</strong> The red dot shows where you clicked. Click multiple times to find the perfect center!</p>
        </div>

        <div class="important-note">
            <strong>‚ö†Ô∏è IMPORTANT - About Rotation:</strong><br>
            This tool captures <strong>PURE SVG COORDINATES WITHOUT ANY ROTATION</strong>.
            The application uses a 21.3¬∞ rotated coordinate system.
            <strong>You MUST use these coordinates with the Coordinate Compensator tool</strong> to apply the transformation.
            <br><br>
            <strong>Do NOT paste these coordinates directly into building_m_rooms.json</strong> - they won't match the map positions!
        </div>

        <div id="status"></div>

        <h3>Select Room:</h3>
        <div class="room-list" id="roomList"></div>

        <h3>SVG Floor Plan:</h3>
        <div class="svg-container" id="svgContainer">
            <div id="svgDisplay">Loading SVG...</div>
        </div>

        <div class="coordinates-display" id="coordsDisplay" style="display: none;">
            <h3>üìç Coordinates for: <span id="selectedRoomName"></span></h3>

            <div class="coord-item">
                <div class="coord-label">SVG Coordinates (X, Y) - NO ROTATION:</div>
                <div class="coord-value" id="svgCoords">Click on the map</div>
                <div class="rotation-info">
                    ‚ÑπÔ∏è These are pure SVG coordinates. <strong>Rotation is NOT applied</strong>.
                    Use Coordinate Compensator to transform.
                </div>
            </div>

            <div class="coord-item">
                <div class="coord-label">JSON Format (copy this):</div>
                <div class="json-output" id="jsonOutput">Click on the map</div>
            </div>

            <div class="next-steps">
                <h4>üîÑ Next Steps:</h4>
                <ol>
                    <li>Copy the JSON coordinates above</li>
                    <li>Go to: <strong>http://localhost:8081/tools/coordinate_compensator.html</strong></li>
                    <li>Paste coordinates into Step 3 (Batch Conversion)</li>
                    <li>Click "Convert All Rooms" to apply transformation</li>
                    <li>Copy result and paste into building_m_rooms.json</li>
                </ol>
            </div>

            <button class="copy-btn" onclick="copyToClipboard()">üìã Copy JSON</button>
            <button onclick="saveAllCoordinates()">üíæ Show All Coordinates</button>
        </div>

        <div id="allCoordinates" style="display: none; margin-top: 20px;">
            <h3>All Room Centers (JSON) - NO ROTATION:</h3>
            <div class="warning-box">
                <strong>‚ö†Ô∏è Warning:</strong> These coordinates have NO rotation applied.
                They must be processed through the Coordinate Compensator before using in building_m_rooms.json
            </div>
            <div class="json-output" id="allCoordsJson"></div>
            <button class="copy-btn" onclick="copyAllToClipboard()">üìã Copy All JSON</button>
        </div>
    </div>

    <script>
        let selectedRoom = null;
        let allRoomCoordinates = {};
        let svgElement = null;

        const rooms = [
            "Room_1003", "Room_1004", "Room_1006", "Room_1018",
            "Room_1030", "Room_1033", "Room_1035", "Room_1037",
            "Room_1040", "Room_1041", "Room_1045", "Room_1049",
            "Bathroom-Men", "Bathroom-Women", "Bathroom-Accessible",
            "Elevator-M", "Stairs_1", "Stairs_2", "Stairs_3"
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSVG();
            createRoomButtons();
        });

        async function loadSVG() {
            try {
                const response = await fetch('../LeafletJS/Floorplans/Building M/M1_official.svg');
                const svgText = await response.text();

                const svgContainer = document.getElementById('svgDisplay');
                svgContainer.innerHTML = svgText;

                svgElement = svgContainer.querySelector('svg');

                if (svgElement) {
                    // Add click handler to SVG
                    svgElement.addEventListener('click', handleSvgClick);

                    // Style the SVG
                    svgElement.style.width = '100%';
                    svgElement.style.height = 'auto';

                    showStatus('‚úÖ SVG loaded successfully! Select a room and click on the map.', 'success');
                } else {
                    showStatus('‚ùå Error: Could not find SVG element', 'error');
                }
            } catch (error) {
                console.error('Error loading SVG:', error);
                showStatus('‚ùå Error loading SVG: ' + error.message, 'error');
            }
        }

        function createRoomButtons() {
            const roomList = document.getElementById('roomList');

            rooms.forEach(roomId => {
                const button = document.createElement('button');
                button.className = 'room-btn';
                button.textContent = roomId;
                button.onclick = () => selectRoom(roomId);
                button.id = `btn-${roomId}`;
                roomList.appendChild(button);
            });
        }

        function selectRoom(roomId) {
            // Update UI
            rooms.forEach(r => {
                const btn = document.getElementById(`btn-${r}`);
                if (btn) btn.classList.remove('selected');
            });

            const selectedBtn = document.getElementById(`btn-${roomId}`);
            if (selectedBtn) selectedBtn.classList.add('selected');

            selectedRoom = roomId;
            document.getElementById('selectedRoomName').textContent = roomId;
            document.getElementById('coordsDisplay').style.display = 'block';

            // Highlight the room in SVG if it exists
            if (svgElement) {
                const roomElement = svgElement.getElementById(roomId);
                if (roomElement) {
                    // Remove previous highlights
                    const previousHighlights = svgElement.querySelectorAll('.highlight-room');
                    previousHighlights.forEach(el => el.classList.remove('highlight-room'));

                    // Add highlight
                    roomElement.style.fill = 'rgba(255, 152, 0, 0.3)';
                    roomElement.style.stroke = '#ff9800';
                    roomElement.style.strokeWidth = '2';
                    roomElement.classList.add('highlight-room');
                }
            }

            showStatus(`üìç Selected: ${roomId}. Now click on the SVG map at the center of this room.`, 'success');
        }

        /**
         * Handle SVG click - captures PURE SVG coordinates WITHOUT rotation
         * These coordinates must be processed through the Coordinate Compensator
         * to match the application's 21.3¬∞ rotated coordinate system
         */
        function handleSvgClick(event) {
            if (!selectedRoom) {
                showStatus('‚ö†Ô∏è Please select a room first!', 'error');
                return;
            }

            // Get SVG coordinates
            const svg = event.currentTarget;
            const pt = svg.createSVGPoint();
            pt.x = event.clientX;
            pt.y = event.clientY;

            // Transform to SVG coordinate system
            // ‚ö†Ô∏è NO ROTATION APPLIED - coordinates are pure SVG
            const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());

            const x = Math.round(svgP.x * 100) / 100;
            const y = Math.round(svgP.y * 100) / 100;

            // Store coordinates
            allRoomCoordinates[selectedRoom] = { x, y };

            // Display coordinates
            document.getElementById('svgCoords').textContent = `X: ${x}, Y: ${y}`;

            const jsonFormat = `"${selectedRoom}": { "x": ${x}, "y": ${y} }`;
            document.getElementById('jsonOutput').textContent = jsonFormat;

            // Add visual marker
            addClickMarker(event.clientX, event.clientY);

            showStatus(`‚úÖ Coordinates saved for ${selectedRoom}! Remember to use Coordinate Compensator before applying to building_m_rooms.json`, 'success');
        }

        function addClickMarker(clientX, clientY) {
            // Remove previous markers for this room
            const container = document.getElementById('svgContainer');
            const existingMarkers = container.querySelectorAll('.click-marker');
            existingMarkers.forEach(m => m.remove());

            // Add new marker
            const marker = document.createElement('div');
            marker.className = 'click-marker';

            const containerRect = container.getBoundingClientRect();
            marker.style.left = (clientX - containerRect.left + container.scrollLeft) + 'px';
            marker.style.top = (clientY - containerRect.top + container.scrollTop) + 'px';

            container.appendChild(marker);
        }

        function copyToClipboard() {
            const text = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showStatus('‚úÖ Copied to clipboard! Now use Coordinate Compensator to transform.', 'success');
            });
        }

        function saveAllCoordinates() {
            if (Object.keys(allRoomCoordinates).length === 0) {
                showStatus('‚ö†Ô∏è No coordinates saved yet!', 'error');
                return;
            }

            const jsonOutput = JSON.stringify(allRoomCoordinates, null, 2);
            document.getElementById('allCoordsJson').textContent = jsonOutput;
            document.getElementById('allCoordinates').style.display = 'block';

            showStatus(`‚úÖ Showing all ${Object.keys(allRoomCoordinates).length} room coordinates (NO ROTATION)`, 'success');
        }

        function copyAllToClipboard() {
            const text = document.getElementById('allCoordsJson').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showStatus('‚úÖ All coordinates copied to clipboard! Don\'t forget to use the Coordinate Compensator!', 'success');
            });
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
        }
    </script>
</body>
</html>
